<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Adaptive Agent</title>
	<style>
		body { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin: 12px; width: 360px; }
		pre { white-space: pre-wrap; word-wrap: break-word; max-height: 280px; overflow: auto; background: #f6f7f9; padding: 8px; border-radius: 6px; }
		.small { color: #666; font-size: 12px; }
		.row { display: flex; gap: 8px; align-items: center; }
		button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: white; cursor: pointer; }
		button:hover { background: #f3f4f6; }
	</style>
</head>
<body>
	<h3>Adaptive Music Agent</h3>
	<div class="row">
		<button id="refresh">Capture Now</button>
		<span class="small" id="ts"></span>
	</div>
	<div class="row" style="margin-top:8px;">
		<button id="viewer">Open Viewer</button>
		<a class="small" href="options.html" target="_blank">Settings</a>
	</div>
	<div class="small" id="meta"></div>
	<pre id="text"></pre>
	<script>
		async function load() {
			const { lastSnapshot, lastSignals } = await chrome.storage.local.get(["lastSnapshot","lastSignals"]);
			if (lastSnapshot) {
				document.getElementById('meta').textContent = `${lastSnapshot.title} â€” ${lastSnapshot.url}`;
				document.getElementById('text').textContent = lastSnapshot.text || "(no text)";
				document.getElementById('ts').textContent = new Date(lastSnapshot.ts || Date.now()).toLocaleTimeString();
			} else {
				document.getElementById('meta').textContent = "No snapshot yet.";
			}
		}
		document.getElementById('refresh').addEventListener('click', async () => {
			const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
			if (tab?.id) {
				try {
					const res = await chrome.tabs.sendMessage(tab.id, { type: 'SNAPSHOT' });
					await chrome.storage.local.set({ lastSnapshot: { ...res, ts: Date.now() } });
					load();
				} catch (e) {}
			}
		});
		document.getElementById('viewer').addEventListener('click', async () => {
			await chrome.tabs.create({ url: chrome.runtime.getURL('viewer.html') });
		});
		load();
	</script>
</body>
</html>
