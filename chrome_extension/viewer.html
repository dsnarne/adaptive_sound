<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Adaptive Agent — Live Viewer</title>
	<style>
		body { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin: 16px; }
		#wrap { max-width: 900px; margin: 0 auto; }
		pre { white-space: pre-wrap; word-wrap: break-word; min-height: 200px; background: #f6f7f9; padding: 12px; border-radius: 8px; }
		.small { color: #666; font-size: 12px; }
		.row { display: flex; gap: 8px; align-items: center; }
		input[type=text] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
		button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: white; cursor: pointer; }
		button:hover { background: #f3f4f6; }
		label { font-size: 12px; color: #555; }
	</style>
</head>
<body>
	<div id="wrap">
		<h2>Adaptive Music Agent — Live Viewer</h2>
		<div class="row">
			<button id="open">Open Active Tab Snapshot</button>
			<span class="small" id="ts"></span>
		</div>
		<div class="small" id="meta"></div>
		<pre id="text">(waiting for snapshot)</pre>
		<h3>Signals</h3>
		<pre id="signals">(waiting for signals)</pre>
	</div>
	<script>
		async function render(){
			const { lastSnapshot, lastSignals } = await chrome.storage.local.get(["lastSnapshot","lastSignals"]);
			if (lastSnapshot) {
				document.getElementById('meta').textContent = `${lastSnapshot.title} — ${lastSnapshot.url}`;
				document.getElementById('text').textContent = lastSnapshot.text || "(no text)";
				document.getElementById('ts').textContent = new Date(lastSnapshot.ts || Date.now()).toLocaleTimeString();
			}
			document.getElementById('signals').textContent = lastSignals ? JSON.stringify(lastSignals, null, 2) : '(no signals yet)';
		}
		document.getElementById('open').addEventListener('click', async () => {
			const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
			if (tab?.id) {
				try {
					const res = await chrome.tabs.sendMessage(tab.id, { type: 'SNAPSHOT' });
					await chrome.storage.local.set({ lastSnapshot: { ...res, ts: Date.now() } });
					render();
				} catch (e) {}
			}
		});
		setInterval(render, 1500);
		render();
	</script>
</body>
</html>
